# Development Guidelines

## Build & Test Commands
- Build: `go build ./...`
- Run tests: `go test ./...`
- Run specific test: `go test -run TestName ./path/to/package`
- Run tests with coverage: `go test -cover ./...`
- Run linting: `golangci-lint run ./...`
- Format code: `gofmt -s -w .`
- Run code generation: `go generate ./...` (needed before commit if any file has //go:generate directives)
- On completion, run: formatting, code generation, linting and testing
- Never commit without running completion sequence
- Coverage report: `go test -race -coverprofile=coverage.out ./... && go tool cover -func=coverage.out`
- Normalize code comments: `command -v unfuck-ai-comments >/dev/null || go install github.com/umputun/unfuck-ai-comments@latest; unfuck-ai-comments run --fmt --skip=mocks ./...`

## Important Workflow Notes
- Always run tests, linter and normalize comments BEFORE committing anything
- Run tests and linter after making significant changes to verify functionality
- Don't add "Generated with Claude Code" or "Co-Authored-By: Claude" to commit messages or PRs
- Do not include "Test plan" sections in PR descriptions
- Do not add comments that describe changes, progress, or historical modifications. 
- Avoid comments like "new function," "added test," "now we changed this," or "previously used X, now using Y." 
- Comments should only describe the current state and purpose of the code, not its history or evolution.
- Use `go:generate` for generating mocks, never modify generated files manually. Mocks are generated with `moq` and stored in the `mocks` package.
- After important functionality added, update README.md accordingly
- When merging master changes to an active branch, make sure both branches are pulled and up to date first

## Commonly Used Libraries
- Logging: `github.com/go-pkgz/lgr`
- CLI flags: `github.com/jessevdk/go-flags`
- HTTP/REST: `github.com/go-pkgz/rest` with `github.com/go-pkgz/routegroup`
- Database: `github.com/jmoiron/sqlx` with `modernc.org/sqlite`
- Testing: `github.com/stretchr/testify`
- Mock generation: `github.com/matryer/moq`
- OpenAI: `github.com/sashabaranov/go-openai`
- Frontend: HTMX v2. Try to avoid using JS.
- For containerized tests use `github.com/go-pkgz/testutils`
- To access libraries, figure how to use ang check their documentation, use `go doc` command and `gh` tool

## Code Style Guidelines
- Follow [Go Code Review Comments](https://github.com/golang/go/wiki/CodeReviewComments)
- Use snake_case for filenames, camelCase for variables, PascalCase for exported names
- Group imports: standard library, then third-party, then local packages
- Error handling: check errors immediately and return them with context
- Use meaningful variable names; avoid single-letter names except in loops
- Validate function parameters at the start before processing
- Return early when possible to avoid deep nesting
- Keep cyclomatic complexity under 30
- Function size preferences:
  - Aim for functions around 50-60 lines when possible
  - Don't break down functions too small as it can reduce readability
  - Maintain focus on a single responsibility per function
- Comment style: in-function comments should be lowercase sentences
- Code width: keep lines under 130 characters when possible

## Testing
- As you create tests, prefer subtests or table-based, using Testify.
- Don't create too large tests if they complicated, but split it to multiple tests.
- If any mocks are included, they should be generated by matryer/moq.
- Keep tests compact but readable.
- If test has too many subtests, consider splitting it to just multiple tests.
- Never disable tests without a good reason. If you have a good reason, ask for approval first and if accepted, disable them with a comment explaining the reason.
- Never update code with spacial conditions to just pass tests

## Project Architecture

### Routing and Middleware
- Uses `github.com/go-pkgz/routegroup` for HTTP routing with middleware support
- Authentication middleware is conditionally applied using `router.Group().Route()` pattern
- When auth is enabled, protected routes are wrapped in an auth group while login/logout/assets remain unprotected
- Middleware must be registered before routes (routegroup v1.5.3+ requirement)

### Server Configuration
- Server validates that ListenAddr is not empty before starting (empty address causes hang)
- Authentication is optional - controlled by --auth flag
- Static assets served from embedded filesystem (assets/*)
- Templates stored in templates/* and embedded at compile time
- Upload is optional - controlled by --upload.enabled flag
  - Upload route group has no SizeLimit middleware (uses its own MaxBytesReader)
  - Main route group retains SizeLimit(1MB) for all other routes
  - Upload handler uses `os.Create` directly since `fs.FS` is read-only

### File Type Detection
- File viewability determined by extension + content detection (`server/fileinfo.go`)
- `commonTextExtensions` map defines which extensions are viewable as text
- `detectBinaryContent()` method uses `http.DetectContentType` (reads 512 bytes) to detect binaries
- Only files with viewable extensions are content-checked to minimize I/O overhead
- Binary files with text extensions (e.g., ELF named `.jsx`) are correctly identified and excluded from view

## Dependency Management
- All dependencies are vendored (vendor directory is committed)
- When updating routegroup, check for breaking changes in middleware registration order
- Dependencies updated periodically as a batch for security and compatibility

## Release Process
- Semantic versioning format: v0.x.x
- Hotfixes increment patch version (e.g., v0.14.3 -> v0.14.4)
- GitHub release titles must use format: "Version x.y.z"
- Release notes sections: Dependencies Updated, Bug Fixes, Technical Changes
- Create tag first, then create GitHub release using `gh release create`

## E2E Testing
- Uses `playwright-go` with build tag `//go:build e2e` for isolation
- Tests in `e2e/` directory, organized by feature: `e2e_test.go` (setup + basic), `auth_test.go`, `nav_test.go`, `sort_test.go`, `view_test.go`, `api_test.go`, `upload_test.go`
- Main server on port 18080 (no auth), auth tests on port 18081 (with auth) to avoid rate limiter conflicts
- Run with `make e2e` (headless) or `make e2e-ui` (visible browser for debugging)
- Setup browsers once with `make e2e-setup`